function init_mapspast(){if(mapset="mapspast",e=mapBounds,"undefined"!=typeof map){var e=map.getExtent();map.destroy()}do_init(),map.zoomToExtent(e)}function init_linz(){mapset="linz",currentextent=mapBounds,"undefined"!=typeof map&&(currentextent=map.getExtent(),map.destroy()),do_init(),map.zoomToExtent(currentextent),map.zoomIn()}function init(){"undefined"==typeof map&&(do_init(),setTimeout(function(){mapLayers()},500))}function do_init(){var e=(location.search.split("x=")[1]||"").split("&")[0],t=(location.search.split("y=")[1]||"").split("&")[0];maximise=(location.search.split("maximise=")[1]||"").split("&")[0],"undefined"==typeof layerid&&(layerid=decodeURI((location.search.split("layerid=")[1]||"").split("&")[0]));var n=(location.search.split("zoom=")[1]||"").split("&")[0];Proj4js.defs["EPSG:2193"]="+proj=tmerc +lat_0=0 +lon_0=173 +k=0.9996 +x_0=1600000 +y_0=10000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs",Proj4js.defs["EPSG:999999"]="+proj=tmerc +lat_0=0 +lon_0=167.5 +k=0.9996 +x_0=1600000 +y_0=10000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs",Proj4js.defs["EPSG:999998"]="+proj=tmerc +lat_0=0 +lon_0=170 +k=0.9996 +x_0=1600000 +y_0=10000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs",Proj4js.defs["EPSG:999997"]="+proj=tmerc +lat_0=0 +lon_0=167.625 +k=0.9996 +x_0=1600000 +y_0=10000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs",Proj4js.defs["EPSG:900913"]="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs",Proj4js.defs["EPSG:27200"]="+proj=nzmg +lat_0=-41 +lon_0=173 +x_0=2510000 +y_0=6023150 +ellps=intl +datum=nzgd49 +units=m +no_defs",Proj4js.defs["EPSG:27291"]="+proj=tmerc +lat_0=-39 +lon_0=175.5 +k=1 +x_0=274319.5243848086 +y_0=365759.3658464114 +ellps=intl +datum=nzgd49 +to_meter=0.9143984146160287 +no_defs",Proj4js.defs["EPSG:27292"]="+proj=tmerc +lat_0=-44 +lon_0=171.5 +k=1 +x_0=457199.2073080143 +y_0=457199.2073080143 +ellps=intl +datum=nzgd49 +to_meter=0.9143984146160287 +no_defs",Proj4js.defs["ESPG:4326"]="+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs ",Proj4js.defs["ESPG:4272"]="+proj=longlat +ellps=intl +datum=nzgd49 +no_defs",Proj4js.defs["ESPG:4167"]="+proj=longlat +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +no_defs",window.onresize=function(){setTimeout(function(){map.updateSize()},1e3)};var a={projection:new OpenLayers.Projection("EPSG:2193"),displayProjection:new OpenLayers.Projection("EPSG:"+current_proj),units:"m",maxResolution:4891.969809375,numZoomLevels:11,maxExtent:new OpenLayers.Bounds(-20037508,-20037508,20037508,20037508.34)},o={projection:new OpenLayers.Projection("EPSG:2193"),displayProjection:new OpenLayers.Projection("EPSG:"+current_proj),units:"m",resolutions:[8960,4480,2240,1120,560,280,140,70,28,14,7,2.8,1.4,.7,.28,.14,.07],numZoomLevels:11,maxExtent:new OpenLayers.Bounds(827933.23,3729820.29,3195373.59,7039943.58)};if(map="mapspast"==mapset?new OpenLayers.Map("map_map",a):new OpenLayers.Map("map_map",o),renderer=OpenLayers.Util.getParameters(window.location.href).renderer,renderer=renderer?[renderer]:OpenLayers.Layer.Vector.prototype.renderers,map.events.register("moveend",map,check_zoomend),"mapspast"==mapset){var r=new OpenLayers.Layer.TMS("NZTM Topo 2009","http://au.mapspast.org.nz/topo50/",{serviceVersion:".",layername:".",alpha:!0,type:"png",isBaseLayer:!0,getURL:getURL}),i=new OpenLayers.Layer.TMS("NZMS260 1999","http://au.mapspast.org.nz/nzms260-1999/",{serviceVersion:".",layername:".",alpha:!0,type:"png",isBaseLayer:!0,getURL:getURL}),s=new OpenLayers.Layer.TMS("NZMS1/260 1989","http://au.mapspast.org.nz/nzms-1989/",{serviceVersion:".",layername:".",alpha:!0,type:"png",isBaseLayer:!0,getURL:getURL}),l=new OpenLayers.Layer.TMS("NZMS1 1979","http://au.mapspast.org.nz/nzms-1979/",{serviceVersion:".",layername:".",alpha:!0,type:"png",isBaseLayer:!0,getURL:getURL}),p=new OpenLayers.Layer.TMS("NZMS1 1969","http://au.mapspast.org.nz/nzms-1969/",{serviceVersion:".",layername:".",alpha:!0,type:"png",isBaseLayer:!0,getURL:getURL}),m=new OpenLayers.Layer.TMS("NZMS1 1959","http://au.mapspast.org.nz/nzms-1959/",{serviceVersion:".",layername:".",alpha:!0,type:"png",isBaseLayer:!0,getURL:getURL}),d=new OpenLayers.Layer.TMS("NZMS15 1949","http://au.mapspast.org.nz/nzms15-1949/",{serviceVersion:".",layername:".",alpha:!0,type:"png",isBaseLayer:!0,getURL:getURL}),c=new OpenLayers.Layer.TMS("NZMS13 1939","http://au.mapspast.org.nz/nzms13-1939/",{serviceVersion:".",layername:".",alpha:!0,type:"png",isBaseLayer:!0,getURL:getURL}),u=new OpenLayers.Layer.TMS("NZMS13 1929","http://au.mapspast.org.nz/nzms13-1929/",{serviceVersion:".",layername:".",alpha:!0,type:"png",isBaseLayer:!0,getURL:getURL}),y=new OpenLayers.Layer.TMS("NZMS13 1919","http://au.mapspast.org.nz/nzms13-1919/",{serviceVersion:".",layername:".",alpha:!0,type:"png",isBaseLayer:!0,getURL:getURL}),g=new OpenLayers.Layer.TMS("NZMS13 1909","http://au.mapspast.org.nz/nzms13-1909/",{serviceVersion:".",layername:".",alpha:!0,type:"png",isBaseLayer:!0,getURL:getURL}),f=new OpenLayers.Layer.TMS("NZMS13 1899","http://au.mapspast.org.nz/nzms13-1899/",{serviceVersion:".",layername:".",alpha:!0,type:"png",isBaseLayer:!0,getURL:getURL});map.addLayers([r,i,s,l,p,m,d,c,u,y,g,f]),""!=document.extentform.layerid.value&&create_selected_layer(document.extentform.layerid.value,document.extentform.serverpath.value)}else{var _=new OpenLayers.Layer.TMS("(LINZ) Topo50 latest","http://tiles-a.data-cdn.linz.govt.nz/services;key=d8c83efc690a4de4ab067eadb6ae95e4/tiles/v4/layer=767/EPSG:2193/",{type:"png",getURL:overlay_getLinzTileURL,isBaseLayer:!0,tileOrigin:new OpenLayers.LonLat(-1e6,1e7),rowSign:1}),h=new OpenLayers.Layer.TMS("(LINZ) Airphoto latest","http://tiles-a.data-cdn.linz.govt.nz/services;key=d8c83efc690a4de4ab067eadb6ae95e4/tiles/v4/set=2/EPSG:2193/",{type:"png",getURL:overlay_getLinzTileURL,isBaseLayer:!0,tileOrigin:new OpenLayers.LonLat(-1e6,1e7),rowSign:1});map.addLayers([_,h])}vectorLayer=new OpenLayers.Layer.Vector("Current feature",{renderers:["Canvas","VML"],displayInLayerSwitcher:!1});var L=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);L.fillColor="#ffffff",L.strokeColor="#ff0000",L.fillOpacity=.7,vectorLayer.style=L,add_click_to_query_controller(),click_to_query=new OpenLayers.Control.Click,map.addControl(click_to_query),add_click_to_create_controller_grid(),click_to_create_grid=new OpenLayers.Control.Click,map.addControl(click_to_create_grid);var v=new OpenLayers.Control.Button({displayClass:"olControlInfo",trigger:mapInfo,title:"Show mapsheet details for current series when you click on the map"}),x=new OpenLayers.Control.Button({displayClass:"olControlSearch",trigger:mapSearch,title:"List all available mapsheets at point you click on the map"}),w=new OpenLayers.Control.Button({displayClass:"olControlMaxExtent",trigger:zoom_to_mapsheet,title:"Zoom to extent of current mapsheet/series"}),E=new OpenLayers.Control.Button({displayClass:"olControlUrl",trigger:showUrl,title:"Show URL of currently displayed map"}),O=new OpenLayers.Control.Button({displayClass:"olControlLayers",trigger:mapLayers,title:"Select basemap"}),B=new OpenLayers.Control.Button({displayClass:"olControlKey",trigger:mapKey,title:"Configure map"}),z=new OpenLayers.Control.Panel({createControlMarkup:function(e){var t=document.createElement("button"),n=document.createElement("span"),a=document.createElement("span");return n.innerHTML="&nbsp;",t.appendChild(n),e.text&&(a.innerHTML=e.text),t.appendChild(a),t}});z.addControls([O,B,v,x,w,E]),map.addControls([new OpenLayers.Control.Zoom,new OpenLayers.Control.Navigation,new OpenLayers.Control.Scale,z]),map.addControl(new OpenLayers.Control.MousePosition({prefix:current_projname+": ",numDigits:current_projdp})),"selected sheet"==document.extentform.dsheetid.value&&create_selected_layer(document.extentform.layerid.value,document.extentform.serverpath.value),map.addLayers([vectorLayer]),""!=document.extentform.dxleft.value&&""!=document.extentform.dxright.value&&""!=document.extentform.dytop.value&&""!=document.extentform.dybottom.value&&(preferredExtent=new OpenLayers.Bounds(document.extentform.dxleft.value,document.extentform.dybottom.value,document.extentform.dxright.value,document.extentform.dytop.value)),map.zoomToExtent(preferredExtent.transform(map.displayProjection,map.projection)),"undefined"!=typeof n&&n>="0"&&map.zoomTo(n-5),"undefined"!=typeof e&&"undefined"!=typeof t&&map.panTo([e,t]),""!=layerid&&("(LINZ"==layerid.substring(0,5)?select_maplayer(layerid,"","linz",0,19):(ourlayer=map.getLayersByName(layerid),ourlayer.length>0&&map.setBaseLayer(ourlayer[0]))),""!=document.extentform.dsheetid.value&&(ourlayer=map.getLayersByName(document.extentform.dsheetid.value),ourlayer.length>0&&map.setBaseLayer(ourlayer[0])),"1"==maximise&&setTimeout(function(){zoom_to_mapsheet()},500)}function hide_uploaded_map(){"undefined"!=typeof tiff_map&&(tiff_map.destroy(),map.innerHTML="",do_init(),"undefined"!=typeof document.getElementById("showupload")&&(document.getElementById("showupload").style.display="block",document.getElementById("hideupload").style.display="none"))}function show_uploaded_map(){map.destroy(),map.innerHTML="",init_tiff_map(),document.getElementById("showupload").style.display="none",document.getElementById("hideupload").style.display="block"}function init_tiff_map(){var e=new OpenLayers.Projection("EPSG:27291"),t=document.selectform.mapName.value,n={div:"map_map",controls:[],projection:"EPSG:900913",displayProjection:new OpenLayers.Projection("EPSG:"+tiffProj),numZoomLevels:20};tiff_map=new OpenLayers.Map(n);var a=new OpenLayers.Layer.TMS("Preview","http://mapspast.org.nz/cgi-bin/mapserv?map=/var/www/html/maps/"+t+".map&layer=test&mode=tile&tile=",{serviceVersion:".",layername:".",alpha:!0,type:"png",isBaseLayer:!0,getURL:getTiffURL});tiff_map.addLayers([a]),vectorLayer=new OpenLayers.Layer.Vector("Current feature",{projection:new OpenLayers.Projection("EPSG:900913"),displayInLayerSwitcher:!1}),vectorLayer.redraw(!0),tiff_map.addLayer(vectorLayer),tiff_map.zoomToExtent(tiffBounds.transform(e,tiff_map.projection)),tiff_map.addControls([new OpenLayers.Control.Zoom,new OpenLayers.Control.MousePosition,new OpenLayers.Control.Navigation]),add_click_to_create_controller(),click_to_create=new OpenLayers.Control.Click,tiff_map.addControl(click_to_create)}function getURL(e){e=this.adjustBounds(e);var t,n=map.baseLayer.name;t="selected sheet"==n?document.extentform.maxzoom.value-5:mapMaxZoom;var a=this.getServerResolution(),o=Math.round((e.left-this.tileOrigin.lon)/(a*this.tileSize.w)),r=Math.round((e.bottom-this.tileOrigin.lat)/(a*this.tileSize.h)),i=this.getServerZoom()+5,s=this.serviceVersion+"/"+this.layername+"/"+i+"/"+o+"/"+r+"."+this.type,l=this.url;return OpenLayers.Util.isArray(l)&&(l=this.selectUrl(s,l)),mapBounds.intersectsBounds(e)&&i>=mapMinZoom+5&&t+5>=i?l+s:emptyTileURL}function overlay_getLinzTileURL(e){var t=this.map.getResolution(),n=Math.round((e.left-this.tileOrigin.lon)/(t*this.tileSize.w)),a=-Math.round((e.top-this.tileOrigin.lat)/(t*this.tileSize.h)),o=this.map.getZoom();return this.url+o+"/"+n+"/"+a+"."+this.type}function getTiffURL(e){e=this.adjustBounds(e);var t=this.getServerResolution(),n=Math.round((e.left-this.tileOrigin.lon)/(t*this.tileSize.w)),a=-Math.round((this.tileOrigin.lat+e.top)/(t*this.tileSize.h)),o=this.getServerZoom(),r=n+"+"+a+"+"+o,i=this.url;return OpenLayers.Util.isArray(i)&&(i=this.selectUrl(r,i)),tiffBounds.intersectsBounds(e)&&o>=mapMinZoom&&mapMaxZoom>=o?i+r:i+r}function getWindowHeight(){return self.innerHeight?self.innerHeight:document.documentElement&&document.documentElement.clientHeight?document.documentElement.clientHeight:document.body?document.body.clientHeight:0}function getWindowWidth(){return self.innerWidth?self.innerWidth:document.documentElement&&document.documentElement.clientWidth?document.documentElement.clientWidth:document.body?document.body.clientWidth:0}function resize(){var e=document.getElementById("map"),t=document.getElementById("header"),n=document.getElementById("subheader");e.style.height=getWindowHeight()-80+"px",e.style.width=getWindowWidth()-20+"px",t.style.width=getWindowWidth()-20+"px",n.style.width=getWindowWidth()-20+"px",e.updateSize&&e.updateSize()}function linkHandler(){$(".dropdown").removeClass("open"),document.getElementById("page_status").innerHTML="Loading ...",$(function(){$.rails.ajax=function(e){return e.tryCount=e.tryCount?e.tryCount:0,e.timeout=5e3*(e.tryCount+1),e.retryLimit=1,e.complete=function(e,t){"timeout"==t&&(this.tryCount++,document.getElementById("page_status").innerHTML="Retrying ...",this.timeout=15e3*this.tryCount,this.tryCount<=this.retryLimit?$.rails.ajax(this):document.getElementById("page_status").innerHTML="Timeout"),"error"==t&&(document.getElementById("page_status").innerHTML="Error"),"success"==t&&(0==map_size&&map_bigger(),document.getElementById("page_status").innerHTML=""),lastUrl=document.URL},$.ajax(e)}})}function update_title(e){document.getElementById("logo").innerHTML="MapsPast"+e,document.title="MapsPast"+e}function update_heading(e){document.getElementById("logo").innerHTML="MapsPast"+e}function deactivateAllQuery(){document.getElementsByClassName("olControlSearchItemInactive")[0].style.backgroundColor="#FFFFFF",document.getElementsByClassName("olControlInfoItemInactive")[0].style.backgroundColor="#FFFFFF",click_to_query.deactivate(),clickMode=""}function mapInfo(){"search"==clickMode&&deactivateAllQuery(),"query"!=clickMode?(searchMode="current",click_to_query.activate(),clickMode="query",document.getElementsByClassName("olControlInfoItemInactive")[0].style.backgroundColor="#008800"):deactivateAllQuery()}function mapSearch(){"query"==clickMode&&deactivateAllQuery(),"search"!=clickMode?(searchMode="all",click_to_query.activate(),clickMode="search",document.getElementsByClassName("olControlSearchItemInactive")[0].style.backgroundColor="#008800"):deactivateAllQuery()}function add_click_to_query_controller(){OpenLayers.Control.Click=OpenLayers.Class(OpenLayers.Control,{defaultHandlerOptions:{single:!0,"double":!0,pixelTolerance:5,stopSingle:!1,stopDouble:!1},initialize:function(){this.handlerOptions=OpenLayers.Util.extend({},this.defaultHandlerOptions),OpenLayers.Control.prototype.initialize.apply(this,arguments),this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions)},trigger:function(e){var t,n=map.getLonLatFromPixel(e.xy);t="all"==searchMode?"":map.baseLayer.name,BootstrapDialog.show({title:"Selected map sheet",message:$('<div id="info_details2">Retrieving ...</div>'),size:"size-small"}),$.ajax({beforeSend:function(e){e.setRequestHeader("Content-Type","application/javascript"),e.setRequestHeader("Accept","text/javascript")},type:"GET",timeout:1e4,url:"/query/?x="+n.lon+"&y="+n.lat+"&layer="+t,error:function(){document.getElementById("info_details2").innerHTML="Error contacting server"},complete:function(){document.getElementById("page_status").innerHTML=""}})}})}function add_click_to_create_controller_grid(){OpenLayers.Control.Click=OpenLayers.Class(OpenLayers.Control,{defaultHandlerOptions:{single:!0,"double":!0,pixelTolerance:0,stopSingle:!1,stopDouble:!1},initialize:function(){this.handlerOptions=OpenLayers.Util.extend({},this.defaultHandlerOptions),OpenLayers.Control.prototype.initialize.apply(this,arguments),this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions)},trigger:function(e){var t=map.getLonLatFromPixel(e.xy),n=map.projection,a=new OpenLayers.Projection("EPSG:"+document.getElementById("map_map_srid").value),o=new OpenLayers.Geometry.Point(t.lon,t.lat).transform(n,a);document.getElementById("uploadedmap_grid_x"+clickDest).value=o.x,document.getElementById("uploadedmap_grid_y"+clickDest).value=o.y,vectorLayer.destroyFeatures();var r=new OpenLayers.Geometry.Point(t.lon,t.lat),i=new OpenLayers.Feature.Vector(r,null,cross_red);vectorLayer.addFeatures(i)}})}function add_click_to_create_controller(){OpenLayers.Control.Click=OpenLayers.Class(OpenLayers.Control,{defaultHandlerOptions:{single:!0,"double":!0,pixelTolerance:0,stopSingle:!1,stopDouble:!1},initialize:function(){this.handlerOptions=OpenLayers.Util.extend({},this.defaultHandlerOptions),OpenLayers.Control.prototype.initialize.apply(this,arguments),this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions)},trigger:function(e){var t=tiff_map.getLonLatFromPixel(e.xy);if("900913"==tiffProj)projWidth=20037508.34,mapWidth=Number(document.selectform.pix_width.value),mapHeight=Number(document.selectform.pix_height.value),mapWidth>mapHeight?(x=(t.lon+projWidth)*mapWidth/(2*projWidth),y=(-t.lat+projWidth)*mapWidth/(2*projWidth)+(mapHeight-mapWidth)/2):(x=(t.lon+projWidth)*mapHeight/(2*projWidth)+(mapWidth-mapHeight)/2,y=(-t.lat+projWidth)*mapHeight/(2*projWidth));else{var n=new OpenLayers.Geometry.Point(t.lon,t.lat).transform(tiff_map.projection,tiff_map.displayProjection);x=n.x,y=n.y}document.getElementsByName("uploadedmap[pix_x"+clickDest+"]")[clickForm].value=x,document.getElementsByName("uploadedmap[pix_y"+clickDest+"]")[clickForm].value=y,vectorLayer.destroyFeatures();var a=new OpenLayers.Geometry.Point(t.lon,t.lat),o=new OpenLayers.Feature.Vector(a,null,cross_red);vectorLayer.addFeatures(o)}})}function selectPix(e,t){"undefined"==typeof tiff_map?show_uploaded_map():tiff_map.layers||show_uploaded_map(),selectNothing(),document.getElementById(t+e+"plus").style.border="2px solid lightgreen",clickDest=t,clickForm=e,vectorLayer.destroyFeatures(),deactivate_all_click(),click_to_create.activate()}function selectGrid(e){"undefined"==typeof map?hide_uploaded_map():map.layers||hide_uploaded_map(),""==document.getElementById("map_map_srid").value?alert("You must select a projection first"):(selectNothing(),document.getElementById("grid"+e+"plus").style.border="2px solid lightgreen",clickDest=e,vectorLayer.destroyFeatures(),deactivate_all_click(),click_to_create_grid.activate())}function selectNothing(){document.getElementById("tl0plus").style.border="none",document.getElementById("tr0plus").style.border="none",document.getElementById("br0plus").style.border="none",document.getElementById("bl0plus").style.border="none",document.getElementById("tl1plus").style.border="none",document.getElementById("tr1plus").style.border="none",document.getElementById("br1plus").style.border="none",document.getElementById("bl1plus").style.border="none",document.getElementById("tic10plus").style.border="none",document.getElementById("tic20plus").style.border="none",document.getElementById("gridtic1plus").style.border="none",document.getElementById("gridtic2plus").style.border="none",deactivate_all_click()}function deactivate_all_click(){"undefined"!=typeof click_to_create&&click_to_create.deactivate()}function zoom_to_mapsheet(){if(layername=map.baseLayer.name,"Undefined"!=document.extentform.xleft&&document.extentform.xleft.value>0){var e=new OpenLayers.Bounds(document.extentform.xleft.value,document.extentform.ybottom.value,document.extentform.xright.value,document.extentform.ytop.value);sheetProjection=new OpenLayers.Projection("EPSG:"+document.extentform.srid.value),zoomExtent=e.transform(sheetProjection,map.projection)}else zoomExtent=preferredExtent.transform(map.displayProjection,map.projection);return map.zoomToExtent(zoomExtent),zoomExtent}function update_selected_layer(e,t,n,a,o,r,i,s){vectorLayer.destroyFeatures(),"undefined"!=typeof map&&("mapspast"!=mapset&&init_mapspast(),ourlayer=map.getLayersByName("selected sheet"),ourlayer.length>0&&map.removeLayer(ourlayer[0]),create_selected_layer(e,t),ourlayer=map.getLayersByName("selected sheet"),ourlayer.length>0&&map.setBaseLayer(ourlayer[0])),document.extentform.xleft.value=n,document.extentform.xright.value=a,document.extentform.ytop.value=o,document.extentform.ybottom.value=r,document.extentform.srid.value=i,document.extentform.layerid.value=e,document.extentform.maxzoom.value=s,document.extentform.serverpath.value=t}function zoom_to_seriessheet(e,t,n,a,o,r){select_maplayer(e,"","mapspast",0,10),document.extentform.xleft.value=n,document.extentform.xright.value=a,document.extentform.ytop.value=r,document.extentform.ybottom.value=o,document.extentform.srid.value=4326,zoom_to_mapsheet(),parser=new OpenLayers.Format.WKT,geometry=parser.read(t);var i=new OpenLayers.Projection("EPSG:4326"),s=new OpenLayers.Projection("EPSG:2193");geomMap=geometry.geometry.transform(i,s),bigPoly=parser.read("POLYGON((748961 3808210, 748961 6836339, 2940563 6836339, 2940563 3808210, 748961 3808210))"),bigPolyMap=bigPoly.geometry.transform(s,s),bigPolyMap.addComponent(geomMap.components[0]),feature=new OpenLayers.Feature.Vector(bigPolyMap),vectorLayer.addFeatures(feature)}function create_selected_layer(e,t){var n=new OpenLayers.Layer.TMS("selected sheet",t+"tiles-"+e+"/",{serviceVersion:".",layername:".",alpha:!0,type:"png",isBaseLayer:!0,getURL:getURL});sheetid=e,map.addLayer(n)}function pollStatus(){setTimeout(function(){document.getElementById("page_status").innerHTML="Processing ...",$.ajax({url:"/mapsheet/"+document.selectform.mapid.value+"/status",type:"GET",success:function(e){var t=e.mapStatus;"..."!=t.substr(t.length-3)?(thisUrl=window.location.href,"edit"!=thisUrl.substr(thisUrl.length-4)&&(thisUrl+="/edit"),window.location=thisUrl):(ms=t.substr(0,t.length-3),"..."==dots?dots=".":dots+=".",document.getElementById("mapstatus").innerHTML=ms+dots)},dataType:"json",always:pollStatus(),timeout:5e3})},5e3)}function check_zoomend(){var e,t=map.baseLayer.name;e="selected sheet"==t?document.extentform.maxzoom.value-5:mapMaxZoom;var n=map.getZoom();n>e&&setTimeout(function(){map.zoomTo(e)},100),mapMinZoom>n&&setTimeout(function(){map.zoomTo(mapMinZoom)},100)}function showInfo(e,t){BootstrapDialog.show({title:e,message:$('<div id="info_details2">Retrieving ...</div>'),size:"size-normal"}),$.ajax({beforeSend:function(e){e.setRequestHeader("Content-Type","application/javascript"),e.setRequestHeader("Accept","text/javascript")},type:"GET",timeout:7e3,error:function(){document.getElementById("info_details2").innerHTML="Error contacting server"},url:t,complete:function(){document.getElementById("page_status").innerHTML=""}})}function showUrl(){var e=Math.round(map.getCenter().lon),t=Math.round(map.getCenter().lat),n=map.getZoom()+5,a=encodeURIComponent(map.baseLayer.name);if("selected%20sheet"==a){url=document.location.origin+"/mapsheet/"+document.extentform.layerid.value;var o=""}else{var o="&layerid="+a;url=document.location.origin}BootstrapDialog.show({title:"URL of current map",message:$("<input id='url' value='"+url+"/?zoom="+n+"&x="+e+"&y="+t+o+"' />")})}function printmap(e){var t=map.getExtent().left,n=map.getExtent().right,a=map.getExtent().top,o=map.getExtent().bottom,r=document.selectform.pix_width.value,i=document.selectform.pix_height.value;layerid=map.baseLayer.name,sheetid=document.extentform.layerid.value;var s=document.extentform.maxzoom.value,l=document.selectform.filename.value;return"http://mapspast.org.nz/"==document.extentform.serverpath.value?window.open("http://mapspast.org.nz/assets/print.html?print=true&left="+t+"&right="+n+"&top="+a+"&bottom="+o+"&sheetid="+sheetid+"&layerid="+layerid+"&wwidth="+r+"&wheight="+i+"&maxzoom="+s+"&filetype="+e+"&filename="+l,"printwindow"):window.open("http://au.mapspast.org.nz/print.html?print=true&left="+t+"&right="+n+"&top="+a+"&bottom="+o+"&sheetid="+sheetid+"&layerid="+layerid+"&wwidth="+r+"&wheight="+i+"&maxzoom="+s+"&filetype="+e+"&filename="+l,"printwindow"),!1}function generate_prj(){filename=document.selectform.filename.value;var e=new Blob(['PROJCS["NZGD_2000_New_Zealand_Transverse_Mercator",GEOGCS["GCS_NZGD_2000",DATUM["D_NZGD_2000",SPHEROID["GRS_1980",6378137.0,298.257222101]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Transverse_Mercator"],PARAMETER["False_Easting",1600000.0],PARAMETER["False_Northing",10000000.0],PARAMETER["Central_Meridian",173.0],PARAMETER["Scale_Factor",0.9996],PARAMETER["Latitude_Of_Origin",0.0],UNIT["Meter",1.0]]'],{type:"text/plain"});saveAs(e,filename+".prj")}function updateDimensions(){var e=document.selectform.size.value;document.selectform.pix_width.value=paperwidths[e],document.selectform.pix_height.value=paperheights[e]}function mapKey(){BootstrapDialog.show({title:"Map options",message:$('<div id="info_details2">Retrieving ...</div>'),size:"size-small"}),$.ajax({beforeSend:function(e){e.setRequestHeader("Content-Type","application/javascript"),e.setRequestHeader("Accept","text/javascript")},type:"GET",timeout:1e4,url:"/legend?projection="+current_proj,error:function(){document.getElementById("info_details2").innerHTML="Error contacting server"},complete:function(){document.getElementById("page_status").innerHTML=""}})}function mapLayers(){BootstrapDialog.show({title:"Select basemap",message:$('<div id="info_details2">Retrieving ...</div>'),size:"size-small"}),$.ajax({beforeSend:function(e){e.setRequestHeader("Content-Type","application/javascript"),e.setRequestHeader("Accept","text/javascript")},type:"GET",timeout:1e4,url:"/layerswitcher?baselayer="+map.baseLayer.name,error:function(){document.getElementById("info_details2").innerHTML="Error contacting server"},complete:function(){document.getElementById("page_status").innerHTML=""}})}function select_maplayer(e,t,n,a,o){vectorLayer.destroyFeatures(),document.extentform.xleft.value=null,document.extentform.xright.value=null,document.extentform.ytop.value=null,document.extentform.ybottom.value=null,$.each(BootstrapDialog.dialogs,function(e,t){t.close()}),layerid="","mapspast"==mapset&&"linz"==n&&init_linz(),"linz"==mapset&&"mapspast"==n&&init_mapspast();var r=map.getLayersByName(e)[0];map.setBaseLayer(r),map.baseLayer.setVisibility(!0),"selected sheet"==e&&(o=document.extentform.maxzoom.value-5),mapMinZoom=a,mapMaxZoom=o,map.getZoom()>o&&setTimeout(function(){check_zoomend()},500)}function updateProjection(){current_proj=document.getElementById("projections").value,current_projname=getSelectedText("projections"),current_projdp="4326"==current_proj||"4272"==current_proj||"4167"==current_proj?4:0,$.each(BootstrapDialog.dialogs,function(e,t){t.close()}),"mapspast"==mapset?init_mapspast():init_linz()}function getSelectedText(e){var t=document.getElementById(e);return-1==t.selectedIndex?null:t.options[t.selectedIndex].text}function map_bigger(){return document.getElementById("map_map").style.display="none",1==map_size&&($("#left_panel_container").toggleClass("span3 span12"),$("#right_panel").toggleClass("span9 span0"),setTimeout(function(){document.getElementById("right_panel").style.display="none"},100),map_size=2),0==map_size&&($("#left_panel_container").toggleClass("span0 span3"),$("#right_panel").toggleClass("span12 span9"),document.getElementById("right_panel").style.marginLeft="25%",document.getElementById("right_panel").style.width="75%",document.getElementById("map_map").style.width="75%",document.getElementById("left_panel_container").style.display="block",map_size=1),setTimeout(function(){map.updateSize(),document.getElementById("map_map").style.display="block",setTimeout(function(){map.updateSize()},1e3),map.updateSize()},200),!1}function map_smaller(){return document.getElementById("map_map").style.display="none",1==map_size&&($("#left_panel_container").toggleClass("span3 span0"),$("#right_panel").toggleClass("span9 span12"),document.getElementById("right_panel").style.marginLeft="0px",document.getElementById("right_panel").style.width="100%",document.getElementById("map_map").style.width="100%",document.getElementById("left_panel_container").style.display="none",map_size=0),2==map_size&&(document.getElementById("right_panel").style.display="block",$("#left_panel_container").toggleClass("span12 span3"),$("#right_panel").toggleClass("span0 span9"),map_size=1),setTimeout(function(){map.updateSize(),document.getElementById("map_map").style.display="block",setTimeout(function(){map.updateSize()},1e3),map.updateSize()},200),!1}if("undefined"==typeof lastUrl)var lastUrl=document.URL;window.onpopstate=function(){document.URL!=lastUrl&&location.reload()};var map_size=1,tiff_map,dots="",map,geometry,feature,geomMap,bigPoly,maximise,vectorLayer,ourcanvas,searchMode,cross_red,click_to_create,click_to_create_grid,clickDest,clickForm,layer_style,clickMode="",mapBounds=new OpenLayers.Bounds(748961,3808210,2940563,6836339),preferredExtent=new OpenLayers.Bounds(1078269,4639780,2098245,6268806),tiffBounds=new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),tiffProj="900913",mapMinZoom=0,mapMaxZoom=10,emptyTileURL="http://au.mapspast.org.nz/none.png",renderer,sheetid,layerid,mapset="mapspast",current_proj="2193",current_projname="NZTM2000",current_projdp=0;OpenLayers.IMAGE_RELOAD_ATTEMPTS=3,cross_red=OpenLayers.Util.extend({},layer_style),cross_red.strokeColor="none",cross_red.fillColor="red",cross_red.graphicName="cross",cross_red.pointRadius=5,cross_red.strokeWidth=0,cross_red.rotation=0,cross_red.strokeLinecap="butt",onresize=function(){resize()};